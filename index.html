  <!DOCTYPE html>
  <html lang="ar" dir="rtl">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>تطبيق تسجيل نشاط الحج</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>
          body {
              font-family: system-ui, -apple-system, sans-serif;
              background-color: #f8f9fa;
          }
          .activity-card {
              background: white;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .location-text {
              color: #666;
              font-size: 0.9em;
          }
          .timestamp {
              color: #888;
              font-size: 0.8em;
          }
          .activities-container {
              max-height: 400px;
              overflow-y: auto;
          }
      </style>
  </head>
  <body>
      <div class="container py-4">
          <!-- الهيدر -->
          <header class="border-bottom mb-4">
              <div class="d-flex justify-content-between align-items-center pb-3">
                  <button class="btn btn-link">✕</button>
                  <h1 class="h4 mb-0">تطبيق تسجيل نشاط الحج</h1>
                  <button class="btn btn-link">⋮</button>
              </div>
          </header>

          <!-- نموذج إدخال النشاط -->
          <div class="mb-4">
              <h2 class="h5 mb-3">تسجيل نشاط جديد</h2>
              <textarea 
                  id="activityInput" 
                  class="form-control mb-3" 
                  rows="4" 
                  placeholder="اكتب وصف نشاطك هنا..."></textarea>
              
              <div class="d-flex gap-2">
                  <button onclick="saveActivity()" class="btn btn-primary flex-grow-1">
                      حفظ النشاط
                  </button>
                  <button onclick="exportToExcel()" class="btn btn-success">
                      تصدير Excel
                  </button>
              </div>
          </div>

          <!-- رسالة الخطأ -->
          <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>

          <!-- قائمة الأنشطة -->
          <div class="mt-4">
              <h3 class="h5 mb-3">الأنشطة المسجلة</h3>
              <div id="activitiesList" class="activities-container"></div>
          </div>
      </div>

      <script>
          let activities = JSON.parse(localStorage.getItem('hajjActivities') || '[]');

          function formatDate(date) {
              return new Date(date).toLocaleString('ar-SA', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
              });
          }

          function showError(message) {
              const errorAlert = document.getElementById('errorAlert');
              errorAlert.textContent = message;
              errorAlert.classList.remove('d-none');
              setTimeout(() => errorAlert.classList.add('d-none'), 5000);
          }

          function displayActivities() {
              const container = document.getElementById('activitiesList');
              container.innerHTML = activities.map(activity => `
                  <div class="activity-card">
                      <div class="timestamp mb-2">
                          ${formatDate(activity.timestamp)}
                      </div>
                      <div class="mb-2">
                          ${activity.text}
                      </div>
                      ${activity.location ? `
                          <div class="location-text">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                  <circle cx="12" cy="10" r="3"></circle>
                              </svg>
                              ${activity.location.address || `${activity.location.lat}, ${activity.location.lng}`}
                          </div>
                      ` : ''}
                  </div>
              `).join('');
          }

          async function saveActivity() {
              const activityText = document.getElementById('activityInput').value.trim();
              
              if (!activityText) {
                  showError('الرجاء إدخال وصف النشاط');
                  return;
              }

              try {
                  const position = await new Promise((resolve, reject) => {
                      navigator.geolocation.getCurrentPosition(resolve, reject, {
                          enableHighAccuracy: true,
                          timeout: 10000,
                          maximumAge: 0
                      });
                  });

                  const newActivity = {
                      id: Date.now().toString(),
                      text: activityText,
                      timestamp: new Date().toISOString(),
                      location: {
                          lat: position.coords.latitude,
                          lng: position.coords.longitude
                      }
                  };

                  // محاولة الحصول على العنوان
                  try {
                      const response = await fetch(
                          `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
                      );
                      const data = await response.json();
                      newActivity.location.address = data.display_name;
                  } catch (err) {
                      console.log('تعذر الحصول على العنوان');
                  }

                  activities.unshift(newActivity);
                  localStorage.setItem('hajjActivities', JSON.stringify(activities));
                  document.getElementById('activityInput').value = '';
                  displayActivities();

              } catch (err) {
                  showError('تعذر تحديد الموقع. الرجاء التأكد من تفعيل خدمات الموقع.');
              }
          }

          function exportToExcel() {
              if (activities.length === 0) {
                  showError('لا توجد أنشطة للتصدير');
                  return;
              }

              const csvContent = activities.map(entry => {
                  const date = formatDate(entry.timestamp);
                  const location = entry.location 
                      ? `${entry.location.lat}, ${entry.location.lng}` 
                      : 'غير متوفر';
                  const address = entry.location?.address || 'غير متوفر';
                  return `${date},${location},${address},"${entry.text}"`;
              }).join('\n');

              const header = 'التاريخ والوقت,الموقع,العنوان,النشاط\n';
              const blob = new Blob([header + csvContent], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = `انشطة_الحج_${new Date().toLocaleDateString('ar-SA')}.csv`;
              link.click();
          }

          // عرض الأنشطة عند تحميل الصفحة
          displayActivities();
      </script>
  </body>
  </html>

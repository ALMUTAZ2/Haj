  <!DOCTYPE html>
  <html lang="ar" dir="rtl">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>تطبيق تسجيل نشاط الحج</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
      <style>
          body {
              font-family: system-ui, -apple-system, sans-serif;
              background-color: #f8f9fa;
          }
          .activity-card {
              background: white;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              transition: transform 0.2s;
          }
          .activity-card:hover {
              transform: translateY(-2px);
          }
          .location-text {
              color: #666;
              font-size: 0.9em;
              display: flex;
              align-items: center;
              gap: 5px;
          }
          .timestamp {
              color: #888;
              font-size: 0.8em;
          }
          .activities-container {
              max-height: 400px;
              overflow-y: auto;
              padding-right: 5px;
          }
          .activities-container::-webkit-scrollbar {
              width: 5px;
          }
          .activities-container::-webkit-scrollbar-thumb {
              background-color: #ddd;
              border-radius: 5px;
          }
          .loading {
              display: inline-block;
              width: 20px;
              height: 20px;
              border: 3px solid #f3f3f3;
              border-top: 3px solid #3498db;
              border-radius: 50%;
              animation: spin 1s linear infinite;
          }
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
      </style>
  </head>
  <body>
      <div class="container py-4">
          <header class="border-bottom mb-4">
              <div class="d-flex justify-content-between align-items-center pb-3">
                  <button class="btn btn-link">✕</button>
                  <h1 class="h4 mb-0">تطبيق تسجيل نشاط الحج</h1>
                  <button class="btn btn-link">⋮</button>
              </div>
          </header>

          <div class="mb-4">
              <h2 class="h5 mb-3">تسجيل نشاط جديد</h2>
              <textarea 
                  id="activityInput" 
                  class="form-control mb-3" 
                  rows="4" 
                  placeholder="اكتب وصف نشاطك هنا..."
                  onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); saveActivity(); }"></textarea>
              
              <div class="d-flex gap-2">
                  <button onclick="saveActivity()" id="saveButton" class="btn btn-primary flex-grow-1">
                      حفظ النشاط
                  </button>
                  <button onclick="exportToExcel()" id="exportButton" class="btn btn-success">
                      تصدير Excel
                  </button>
              </div>
          </div>

          <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
          <div id="successAlert" class="alert alert-success d-none" role="alert"></div>

          <div class="mt-4">
              <h3 class="h5 mb-3">الأنشطة المسجلة</h3>
              <div id="activitiesList" class="activities-container"></div>
          </div>
      </div>

      <script>
          let activities = JSON.parse(localStorage.getItem('hajjActivities') || '[]');

          function formatDate(date) {
              return new Date(date).toLocaleString('ar-SA', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
              });
          }

          function showMessage(message, type = 'error') {
              const alertElement = document.getElementById(type === 'error' ? 'errorAlert' : 'successAlert');
              alertElement.textContent = message;
              alertElement.classList.remove('d-none');
              setTimeout(() => alertElement.classList.add('d-none'), 5000);
          }

          function setLoading(isLoading, buttonId) {
              const button = document.getElementById(buttonId);
              if (isLoading) {
                  button.disabled = true;
                  button.innerHTML = '<span class="loading"></span> جاري التنفيذ...';
              } else {
                  button.disabled = false;
                  button.innerHTML = buttonId === 'saveButton' ? 'حفظ النشاط' : 'تصدير Excel';
              }
          }

          function displayActivities() {
              const container = document.getElementById('activitiesList');
              if (activities.length === 0) {
                  container.innerHTML = '<div class="text-center text-muted">لا توجد أنشطة مسجلة</div>';
                  return;
              }
              container.innerHTML = activities.map(activity => `
                  <div class="activity-card">
                      <div class="timestamp mb-2">
                          ${formatDate(activity.timestamp)}
                      </div>
                      <div class="mb-2">
                          ${activity.text}
                      </div>
                      ${activity.location ? `
                          <div class="location-text">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                  <circle cx="12" cy="10" r="3"></circle>
                              </svg>
                              ${activity.location.address || `${activity.location.lat}, ${activity.location.lng}`}
                          </div>
                      ` : ''}
                  </div>
              `).join('');
          }

          async function saveActivity() {
              const activityText = document.getElementById('activityInput').value.trim();
              
              if (!activityText) {
                  showMessage('الرجاء إدخال وصف النشاط');
                  return;
              }

              setLoading(true, 'saveButton');

              try {
                  const position = await new Promise((resolve, reject) => {
                      navigator.geolocation.getCurrentPosition(resolve, reject, {
                          enableHighAccuracy: true,
                          timeout: 10000,
                          maximumAge: 0
                      });
                  });

                  const newActivity = {
                      id: Date.now().toString(),
                      text: activityText,
                      timestamp: new Date().toISOString(),
                      location: {
                          lat: position.coords.latitude,
                          lng: position.coords.longitude
                      }
                  };

                  try {
                      const response = await fetch(
                          `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
                      );
                      const data = await response.json();
                      newActivity.location.address = data.display_name;
                  } catch (err) {
                      console.log('تعذر الحصول على العنوان');
                  }

                  activities.unshift(newActivity);
                  localStorage.setItem('hajjActivities', JSON.stringify(activities));
                  document.getElementById('activityInput').value = '';
                  displayActivities();
                  showMessage('تم حفظ النشاط بنجاح', 'success');

              } catch (err) {
                  showMessage('تعذر تحديد الموقع. الرجاء التأكد من تفعيل خدمات الموقع.');
              } finally {
                  setLoading(false, 'saveButton');
              }
          }

          function exportToExcel() {
              if (activities.length === 0) {
                  showMessage('لا توجد أنشطة للتصدير');
                  return;
              }

              setLoading(true, 'exportButton');

              try {
                  const workbookData = activities.map(activity => ({
                      'التاريخ والوقت': formatDate(activity.timestamp),
                      'النشاط': activity.text,
                      'خط العرض': activity.location?.lat || '',
                      'خط الطول': activity.location?.lng || '',
                      'العنوان': activity.location?.address || ''
                  }));

                  const worksheet = XLSX.utils.json_to_sheet(workbookData);
                  const workbook = XLSX.utils.book_new();
                  XLSX.utils.book_append_sheet(workbook, worksheet, 'الأنشطة');

                  // تعديل عرض الأعمدة
                  const wscols = [
                      { wch: 25 }, // التاريخ والوقت
                      { wch: 40 }, // النشاط
                      { wch: 15 }, // خط العرض
                      { wch: 15 }, // خط الطول
                      { wch: 50 }  // العنوان
                  ];
                  worksheet['!cols'] = wscols;

                  XLSX.writeFile(workbook, `انشطة_الحج_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
                  showMessage('تم تصدير الملف بنجاح', 'success');
              } catch (error) {
                  showMessage('حدث خطأ أثناء تصدير الملف');
              } finally {
                  setLoading(false, 'exportButton');
              }
          }

          // عرض الأنشطة عند تحميل الصفحة
          displayActivities();
      </script>
  </body>
  </html>؛ 

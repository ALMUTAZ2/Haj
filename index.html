  import React, { useState, useEffect } from 'react';
  import { MapPin, Save, AlertTriangle, X, Clock, Calendar } from 'lucide-react';
  import { Button } from "@/components/ui/button";
  import { Textarea } from "@/components/ui/textarea";
  import { Alert, AlertDescription } from "@/components/ui/alert";
  import { Card, CardContent } from "@/components/ui/card";
  import { ScrollArea } from "@/components/ui/scroll-area";

  interface ActivityEntry {
    id: string;
    text: string;
    timestamp: Date;
    location?: {
      lat: number;
      lng: number;
      address?: string;
    };
  }

  const HajjActivityTracker = () => {
    const [activity, setActivity] = useState('');
    const [error, setError] = useState('');
    const [activities, setActivities] = useState<ActivityEntry[]>([]);
    const [locationStatus, setLocationStatus] = useState<'checking' | 'available' | 'unavailable'>('checking');

    useEffect(() => {
      checkLocationPermission();
      // استرجاع الأنشطة المحفوظة
      const savedActivities = localStorage.getItem('hajjActivities');
      if (savedActivities) {
        setActivities(JSON.parse(savedActivities).map((act: ActivityEntry) => ({
          ...act,
          timestamp: new Date(act.timestamp)
        })));
      }
    }, []);

    const checkLocationPermission = () => {
      if (!navigator.geolocation) {
        setLocationStatus('unavailable');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        () => setLocationStatus('available'),
        () => setLocationStatus('unavailable')
      );
    };

    const formatDate = (date: Date) => {
      return new Intl.DateTimeFormat('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      }).format(date);
    };

    const handleSave = async () => {
      if (!activity.trim()) {
        setError('الرجاء إدخال وصف النشاط');
        return;
      }

      try {
        setError('جاري حفظ النشاط...');
        const position = await new Promise<GeolocationPosition>((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });

        const newActivity: ActivityEntry = {
          id: Date.now().toString(),
          text: activity,
          timestamp: new Date(),
          location: {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          }
        };

        // محاولة الحصول على العنوان من الإحداثيات
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
          );
          const data = await response.json();
          newActivity.location!.address = data.display_name;
        } catch (err) {
          console.log('تعذر الحصول على العنوان');
        }

        const updatedActivities = [newActivity, ...activities];
        setActivities(updatedActivities);
        localStorage.setItem('hajjActivities', JSON.stringify(updatedActivities));
        
        setActivity('');
        setError('');
      } catch (err) {
        setError('تعذر تحديد الموقع');
      }
    };

    const exportToExcel = () => {
      // تحويل البيانات إلى صيغة CSV
      const csvContent = activities.map(entry => {
        const date = formatDate(entry.timestamp);
        const location = entry.location 
          ? `${entry.location.lat}, ${entry.location.lng}` 
          : 'غير متوفر';
        const address = entry.location?.address || 'غير متوفر';
        return `${date},${location},${address},"${entry.text}"`;
      }).join('\n');

      const header = 'التاريخ والوقت,الموقع,العنوان,النشاط\n';
      const blob = new Blob([header + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `انشطة_الحج_${new Date().toLocaleDateString('ar-SA')}.csv`;
      link.click();
    };

    return (
      <div className="bg-white min-h-screen" dir="rtl">
        <header className="border-b">
          <div className="flex items-center justify-between p-4">
            <X className="h-6 w-6" />
            <h1 className="text-lg font-semibold">تطبيق تسجيل نشاط الحج</h1>
            <button className="w-6">⋮</button>
          </div>
        </header>

        <main className="p-4 space-y-6">
          <div className="flex items-center gap-2">
            <MapPin className="h-6 w-6" />
            <h2 className="text-xl font-bold">تسجيل نشاط الحج</h2>
          </div>

          <Textarea
            value={activity}
            onChange={(e) => setActivity(e.target.value)}
            placeholder="اكتب وصف نشاطك هنا..."
            className="min-h-[120px] text-right"
          />

          <div className="flex gap-2">
            <Button 
              onClick={handleSave}
              className="flex-1 bg-slate-800 hover:bg-slate-700"
              disabled={locationStatus === 'unavailable'}
            >
              <Save className="ml-2 h-5 w-5" />
              حفظ النشاط
            </Button>

            <Button 
              onClick={exportToExcel}
              variant="outline"
              className="bg-green-50 hover:bg-green-100"
              disabled={activities.length === 0}
            >
              تصدير Excel
            </Button>
          </div>

          {error && (
            <Alert variant="destructive">
              <AlertTriangle className="h-5 w-5" />
              <AlertDescription className="mr-2">{error}</AlertDescription>
            </Alert>
          )}

          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-4">الأنشطة المسجلة</h3>
            <ScrollArea className="h-[400px]">
              {activities.map((entry) => (
                <Card key={entry.id} className="mb-4">
                  <CardContent className="p-4">
                    <div className="flex items-center gap-2 text-gray-600 mb-2">
                      <Calendar className="h-4 w-4" />
                      <span className="text-sm">{formatDate(entry.timestamp)}</span>
                    </div>
                    <p className="mb-2">{entry.text}</p>
                    {entry.location && (
                      <div className="flex items-center gap-2 text-gray-600">
                        <MapPin className="h-4 w-4" />
                        <span className="text-sm">
                          {entry.location.address || `${entry.location.lat}, ${entry.location.lng}`}
                        </span>
                      </div>
                    )}
                  </CardContent>
                </Card>
              ))}
            </ScrollArea>
          </div>
        </main>
      </div>
    );
  };

  export default HajjActivityTracker;
